<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>월별 자금현황 PDF Export</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .main-content {
            padding: 30px;
        }

        .auto-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #10b981;
            text-align: center;
        }

        .auto-section h3 {
            color: #065f46;
            margin-bottom: 15px;
        }

        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            text-align: center;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
        }

        #pdfCanvas {
            display: none;
            border: 1px solid #ddd;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 월별 자금현황 PDF Export</h1>
            <p>Canvas 기반 이미지 PDF 생성</p>
        </div>

        <div class="main-content">
            <div class="auto-section">
                <h3>🚀 이미지 기반 PDF 생성</h3>
                <p>Canvas를 사용해서 이미지로 PDF를 생성합니다</p>
                <button class="btn" onclick="generateImagePDF()">📄 이미지 PDF 생성</button>
            </div>

            <div id="statusDiv"></div>
            <canvas id="pdfCanvas" width="595" height="842"></canvas>
        </div>
    </div>

    <script>
        // URL 파라미터에서 rowId 추출
        const urlParams = new URLSearchParams(window.location.search);
        const rowId = urlParams.get('rowId');

        window.onload = function() {
            if (rowId) {
                showStatus('ROW ID가 감지되었습니다: ' + rowId, 'info');
                setTimeout(() => {
                    generateImagePDF();
                }, 2000);
            } else {
                showStatus('테스트 모드입니다. 버튼을 클릭해서 샘플 PDF를 생성해보세요.', 'info');
            }
        };

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = '<div class="status ' + type + '">' + message + '</div>';
        }

        function generateImagePDF() {
            showStatus('이미지 PDF를 생성하는 중...', 'info');
            
            const canvas = document.getElementById('pdfCanvas');
            const ctx = canvas.getContext('2d');
            
            // Canvas 크기 설정 (A4: 794x1123px at 96 DPI)
            canvas.width = 794;
            canvas.height = 1123;
            canvas.style.display = 'block';
            
            // 배경색 설정
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 텍스트 스타일 설정
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'left';
            
            let y = 80;
            
            // 제목
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('2025-09월 자금현황 보고서', canvas.width / 2, y);
            y += 50;
            
            // 생성일
            ctx.font = '18px Arial';
            ctx.fillText('생성일: ' + new Date().toLocaleDateString('ko-KR'), canvas.width / 2, y);
            y += 80;
            
            // 선 그리기
            ctx.strokeStyle = '#4f46e5';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(60, y - 30);
            ctx.lineTo(734, y - 30);
            ctx.stroke();
            
            // 월간 요약
            ctx.textAlign = 'left';
            ctx.font = 'bold 24px Arial';
            ctx.fillText('월간 요약', 60, y);
            y += 40;
            
            // 요약 표
            drawTable(ctx, 60, y, [
                ['총 수입', '3,600,000원'],
                ['총 지출', '2,850,000원'],
                ['잔여금', '750,000원']
            ], 270);
            y += 140;
            
            // 수입 현황
            ctx.font = 'bold 24px Arial';
            ctx.fillText('수입 현황', 60, y);
            y += 40;
            
            drawTable(ctx, 60, y, [
                ['급여', '3,200,000원'],
                ['투자수익', '250,000원'],
                ['기타수익', '150,000원'],
                ['총 수입', '3,600,000원']
            ], 270);
            y += 160;
            
            // 지출 현황
            ctx.font = 'bold 24px Arial';
            ctx.fillText('지출 현황', 60, y);
            y += 40;
            
            ctx.font = 'bold 20px Arial';
            ctx.fillText('고정지출', 80, y);
            y += 35;
            
            drawTable(ctx, 80, y, [
                ['대출상환', '300,000원'],
                ['보험료', '180,000원'],
                ['교통비', '120,000원'],
                ['통신비', '75,000원'],
                ['어머니생활비', '500,000원'],
                ['모임회비', '30,000원'],
                ['구독료', '45,000원'],
                ['적금', '800,000원'],
                ['기타', '50,000원'],
                ['고정지출 소계', '2,100,000원']
            ], 250);
            y += 320;
            
            ctx.font = 'bold 20px Arial';
            ctx.fillText('변동지출', 80, y);
            y += 35;
            
            drawTable(ctx, 80, y, [
                ['변동지출 총액', '750,000원']
            ], 250);
            y += 65;
            
            drawTable(ctx, 60, y, [
                ['총 지출', '2,850,000원']
            ], 270);
            
            // Canvas 렌더링 완료 후 이미지 생성
            setTimeout(() => {
                try {
                    // Canvas를 Blob으로 변환
                    canvas.toBlob(function(blob) {
                        const reader = new FileReader();
                        reader.onload = function() {
                            const imgData = reader.result;
                            
                            // PDF 생성
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('p', 'mm', 'a4');
                            
                            // A4 크기로 이미지 추가 (210 x 297 mm)
                            pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                            
                            // 파일명 생성
                            const today = new Date();
                            const dateStr = today.getFullYear() + '-' + 
                                          String(today.getMonth() + 1).padStart(2, '0');
                            
                            pdf.save('월별자금현황_' + dateStr + '.pdf');
                            
                            showStatus('이미지 PDF가 성공적으로 생성되었습니다!', 'success');
                            
                            // Canvas 숨기기
                            canvas.style.display = 'none';
                        };
                        reader.readAsDataURL(blob);
                    }, 'image/png', 1.0);
                    
                } catch (error) {
                    console.error('PDF 생성 오류:', error);
                    showStatus('PDF 생성 중 오류가 발생했습니다: ' + error.message, 'error');
                    canvas.style.display = 'none';
                }
            }, 500); // 렌더링 완료 대기
        }
        
        function drawTable(ctx, x, y, data, colWidth) {
            const rowHeight = 30;
            const tableWidth = colWidth * 2;
            
            // 테이블 테두리
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            
            for (let i = 0; i < data.length; i++) {
                const currentY = y + (i * rowHeight);
                
                // 행 배경 (마지막 행은 강조)
                if (i === data.length - 1) {
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillRect(x, currentY - 20, tableWidth, rowHeight);
                }
                
                // 셀 테두리
                ctx.strokeRect(x, currentY - 20, colWidth, rowHeight);
                ctx.strokeRect(x + colWidth, currentY - 20, colWidth, rowHeight);
                
                // 텍스트
                ctx.fillStyle = '#000000';
                ctx.font = (i === data.length - 1) ? 'bold 16px Arial' : '16px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(data[i][0], x + 15, currentY);
                ctx.textAlign = 'right';
                ctx.fillText(data[i][1], x + tableWidth - 15, currentY);
            }
        }
    </script>
</body>
</html>