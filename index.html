<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL 데이터 기반 월별 자금현황 보고서</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nanum Gothic', 'Malgun Gothic', '맑은 고딕', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .main-content {
            padding: 30px;
        }

        .url-section {
            background: #fff3cd;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #856404;
        }

        .url-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .url-example {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            overflow-x: auto;
        }

        .auto-section {
            background: #e8f5e8;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #10b981;
            text-align: center;
        }

        .auto-section h3 {
            color: #065f46;
            margin-bottom: 15px;
        }

        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            text-align: center;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .report-preview {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            font-family: 'Nanum Gothic', monospace;
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-line;
            max-height: 600px;
            overflow-y: auto;
            color: #2d3748;
        }

        .copy-btn {
            background: #10b981;
            font-size: 0.9em;
            padding: 8px 16px;
        }

        .copy-btn:hover {
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
        }

        .download-btn {
            background: #f59e0b;
            font-size: 0.9em;
            padding: 8px 16px;
        }

        .download-btn:hover {
            box-shadow: 0 8px 15px rgba(245, 158, 11, 0.3);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .data-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
        }

        .data-item strong {
            color: #495057;
            display: block;
            margin-bottom: 5px;
        }

        .data-value {
            font-family: monospace;
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📄 URL 데이터 기반 자금현황 보고서</h1>
            <p>URL 파라미터로 전달받은 데이터를 기반으로 보고서 생성</p>
        </div>

        <div class="main-content">
            <div class="url-section">
                <h3>🔗 URL 파라미터 사용법</h3>
                
                <h4>💡 새로운 방식 (JSON 데이터 - 권장)</h4>
                <p>구조화된 JSON 데이터를 사용하여 더 체계적으로 데이터를 전송:</p>
                <div class="url-example">
https://your-site.com/?data={"rowId":"123","targetMonth":"2025-09","income":{"total":3600000,"salary":3200000,"investment":250000,"other":150000},"expense":{"fixed":{"total":2100000,"transportation":120000,"subscription":45000,"loan":300000,"insurance":180000,"family":500000,"savings":800000,"communication":75000,"other":50000},"variable":750000},"assets":[{"name":"현금","value":5200000,"type":"liquid"},{"name":"적금","value":12500000,"type":"savings"},{"name":"주식","value":3000000,"type":"investment"}]}
                </div>
                
                <h4>🔄 기존 방식 (개별 파라미터 - 하위 호환성)</h4>
                <div class="url-example">
https://your-site.com/?rowId=123&income_total=3600000&income_salary=3200000&income_investment=250000&income_other=150000&expense_fixed_total=2100000&expense_transportation=120000&expense_subscription=45000&expense_loan=300000&expense_insurance=180000&expense_family=500000&expense_savings=800000&expense_communication=75000&expense_other_fixed=50000&expense_variable=750000&asset_cash=5200000&asset_savings=12500000&target_month=2025-09
                </div>
                
                <h4>📋 JSON 데이터 구조:</h4>
                <div class="data-grid">
                    <div class="data-item">
                        <strong>기본 정보</strong>
                        rowId, targetMonth
                    </div>
                    <div class="data-item">
                        <strong>수입 (income)</strong>
                        total, salary, investment, other
                    </div>
                    <div class="data-item">
                        <strong>고정지출 (expense.fixed)</strong>
                        total, transportation, subscription, loan, insurance, family, savings, communication, other
                    </div>
                    <div class="data-item">
                        <strong>변동지출 & 자산 배열</strong>
                        expense.variable, assets[{name, value, type}]
                    </div>
                </div>
            </div>

            <div class="auto-section">
                <h3>📊 보고서 생성</h3>
                <p>URL에서 데이터를 읽어와 자동으로 보고서를 생성합니다</p>
                <button class="btn" onclick="generateReportFromURL()" id="generateBtn">📄 URL 데이터로 보고서 생성</button>
                <button class="btn copy-btn" onclick="copyReport()" id="copyBtn" style="display:none;">📋 텍스트 복사</button>
                <button class="btn download-btn" onclick="downloadReport()" id="downloadBtn" style="display:none;">💾 TXT 파일 다운로드</button>
            </div>

            <div id="statusDiv"></div>
            <div id="dataPreviewDiv"></div>
            <div id="reportDiv"></div>
        </div>
    </div>

    <script>
        // URL 파라미터 파싱
        const urlParams = new URLSearchParams(window.location.search);
        
        // 전역 변수
        window.urlData = null;
        window.generatedReport = null;

        window.onload = function() {
            parseURLData();
            
            if (window.urlData && Object.keys(window.urlData).length > 1) {
                showStatus('URL에서 데이터를 감지했습니다. 자동으로 보고서를 생성합니다...', 'info');
                setTimeout(() => {
                    generateReportFromURL();
                }, 2000);
            } else {
                showStatus('URL 파라미터에 데이터가 없습니다. 테스트 데이터를 사용합니다.', 'warning');
                generateTestReport();
            }
        };

        function parseURLData() {
            let data = {};
            
            // JSON 데이터 파라미터 체크 (새로운 방식)
            const jsonData = urlParams.get('data');
            if (jsonData) {
                try {
                    data = JSON.parse(decodeURIComponent(jsonData));
                    console.log('JSON 데이터 파싱 성공:', data);
                } catch (error) {
                    console.error('JSON 파싱 오류:', error);
                    showStatus('JSON 데이터 파싱 중 오류가 발생했습니다: ' + error.message, 'error');
                }
            } else {
                // 기존 방식 (개별 파라미터) - 하위 호환성
                for (const [key, value] of urlParams.entries()) {
                    if (key.startsWith('income_') || key.startsWith('expense_') || key.startsWith('asset_') || 
                        key === 'rowId' || key === 'target_month') {
                        
                        // 숫자 값은 정수로 변환
                        if (key !== 'rowId' && key !== 'target_month' && !isNaN(value)) {
                            data[key] = parseInt(value);
                        } else {
                            data[key] = value;
                        }
                    }
                }
            }
            
            window.urlData = data;
            
            // 데이터 미리보기 표시
            if (Object.keys(data).length > 0) {
                const previewDiv = document.getElementById('dataPreviewDiv');
                previewDiv.innerHTML = `
                    <h4>📋 URL에서 읽어온 데이터:</h4>
                    <div class="data-grid">
                        ${Object.entries(data).map(([key, value]) => `
                            <div class="data-item">
                                <strong>${key}</strong>
                                <div class="data-value">${typeof value === 'number' ? value.toLocaleString() : value}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusDiv');
            const loadingIcon = type === 'info' && message.includes('중') ? '<span class="loading"></span>' : '';
            statusDiv.innerHTML = '<div class="status ' + type + '">' + loadingIcon + message + '</div>';
        }

        function generateReportFromURL() {
            showStatus('URL 데이터를 기반으로 보고서를 생성하는 중...', 'info');

            try {
                const data = window.urlData || {};
                
                // 현재 날짜
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const date = String(today.getDate()).padStart(2, '0');
                const dateStr = `${year}년 ${month}월 ${date}일`;
                
                // 데이터 형식 감지 및 값 추출
                let rowId, targetMonth, totalIncome, salaryIncome, investmentIncome, otherIncome;
                let totalFixedExpense, variableExpense, totalExpense;
                let transportation, subscription, loanPayment, insurance, familySupport, savings, communication, otherFixed;
                let cashAsset, savingsAsset, totalAsset;
                
                if (data.income && typeof data.income === 'object') {
                    // 새로운 JSON 형식
                    rowId = data.rowId || 'JSON에서 전달받음';
                    targetMonth = data.targetMonth || `${year}-${month}`;
                    
                    // 수입 데이터
                    totalIncome = data.income?.total || 0;
                    salaryIncome = data.income?.salary || 0;
                    investmentIncome = data.income?.investment || 0;
                    otherIncome = data.income?.other || 0;

                    // 지출 데이터
                    totalFixedExpense = data.expense?.fixed?.total || 0;
                    variableExpense = data.expense?.variable || 0;
                    totalExpense = totalFixedExpense + variableExpense;

                    // 고정지출 세부 항목
                    transportation = data.expense?.fixed?.transportation || 0;
                    subscription = data.expense?.fixed?.subscription || 0;
                    loanPayment = data.expense?.fixed?.loan || 0;
                    insurance = data.expense?.fixed?.insurance || 0;
                    familySupport = data.expense?.fixed?.family || 0;
                    savings = data.expense?.fixed?.savings || 0;
                    communication = data.expense?.fixed?.communication || 0;
                    otherFixed = data.expense?.fixed?.other || 0;

                    // 자산 데이터 (배열 구조)
                    const assets = data.assets || [];
                    totalAsset = assets.reduce((sum, asset) => sum + (asset.value || 0), 0);
                    
                    // 기존 호환성을 위한 개별 자산 추출
                    cashAsset = assets.find(a => a.name === '현금')?.value || 0;
                    savingsAsset = assets.find(a => a.name === '적금')?.value || 0;
                } else {
                    // 기존 형식 (하위 호환성)
                    rowId = data.rowId || 'URL에서 전달받음';
                    targetMonth = data.target_month || `${year}-${month}`;
                    
                    // 수입 데이터
                    totalIncome = data.income_total || 0;
                    salaryIncome = data.income_salary || 0;
                    investmentIncome = data.income_investment || 0;
                    otherIncome = data.income_other || 0;

                    // 지출 데이터
                    totalFixedExpense = data.expense_fixed_total || 0;
                    variableExpense = data.expense_variable || 0;
                    totalExpense = totalFixedExpense + variableExpense;

                    // 고정지출 세부 항목
                    transportation = data.expense_transportation || 0;
                    subscription = data.expense_subscription || 0;
                    loanPayment = data.expense_loan || 0;
                    insurance = data.expense_insurance || 0;
                    familySupport = data.expense_family || 0;
                    savings = data.expense_savings || 0;
                    communication = data.expense_communication || 0;
                    otherFixed = data.expense_other_fixed || 0;

                    // 자산 데이터
                    cashAsset = data.asset_cash || 0;
                    savingsAsset = data.asset_savings || 0;
                    totalAsset = cashAsset + savingsAsset;
                }

                // 수지 계산
                const balance = totalIncome - totalExpense;
                const savingsRate = totalIncome > 0 ? ((balance / totalIncome) * 100).toFixed(1) : 0;
                const expenseRate = totalIncome > 0 ? ((totalExpense / totalIncome) * 100).toFixed(1) : 0;

                // 대상월 포맷팅
                const targetMonthFormatted = targetMonth ? 
                    new Date(targetMonth + '-01').toLocaleDateString('ko-KR', {year: 'numeric', month: 'long'}) :
                    `${year}년 ${month}월`;

                // 자산 목록 동적 생성
                const assets = data.assets || [];
                let assetListText = '';
                if (assets.length > 0) {
                    assetListText = assets.map((asset, index) => 
                        `   ${index + 1}. ${asset.name}${' '.repeat(Math.max(1, 20 - asset.name.length))}${asset.value.toLocaleString()}원`
                    ).join('\n');
                } else {
                    // 기존 방식 폴백
                    assetListText = `   1. 현금${' '.repeat(17)}${cashAsset.toLocaleString()}원\n   2. 예적금${' '.repeat(15)}${savingsAsset.toLocaleString()}원`;
                }

                // 보고서 텍스트 생성
                const reportText = `
═══════════════════════════════════════════════════════════════
                        ${targetMonthFormatted} 자금현황 보고서
═══════════════════════════════════════════════════════════════

📅 보고서 생성일: ${dateStr}
📋 보고 대상: ${targetMonthFormatted}
👤 데이터 출처: URL 파라미터 (${rowId})

═══════════════════════════════════════════════════════════════
                            📊 월간 요약
═══════════════════════════════════════════════════════════════

💰 이번 달 총 수입:        ${totalIncome.toLocaleString()}원
💸 이번 달 총 지출:        ${totalExpense.toLocaleString()}원
📈 이번 달 수지차액:        ${balance.toLocaleString()}원
📊 지출율:                     ${expenseRate}%
📊 저축율:                     ${savingsRate}%

═══════════════════════════════════════════════════════════════
                            💵 수입 현황
═══════════════════════════════════════════════════════════════

1. 급여소득                   ${salaryIncome.toLocaleString()}원
2. 투자수익                   ${investmentIncome.toLocaleString()}원
3. 기타수입                   ${otherIncome.toLocaleString()}원
   ─────────────────────────────────────
   💰 총 수입                 ${totalIncome.toLocaleString()}원

═══════════════════════════════════════════════════════════════
                            💸 지출 현황
═══════════════════════════════════════════════════════════════

🔸 고정지출
   1. 대출상환                   ${loanPayment.toLocaleString()}원
   2. 보험료                     ${insurance.toLocaleString()}원
   3. 교통비                     ${transportation.toLocaleString()}원
   4. 통신비                     ${communication.toLocaleString()}원
   5. 가족 생활비                ${familySupport.toLocaleString()}원
   6. 구독료                     ${subscription.toLocaleString()}원
   7. 적금                       ${savings.toLocaleString()}원
   8. 기타                       ${otherFixed.toLocaleString()}원
   ─────────────────────────────────────
   소계 (고정지출)             ${totalFixedExpense.toLocaleString()}원

🔸 변동지출
   1. 변동지출 합계              ${variableExpense.toLocaleString()}원
   ─────────────────────────────────────
   소계 (변동지출)             ${variableExpense.toLocaleString()}원

   ─────────────────────────────────────
   💸 총 지출                 ${totalExpense.toLocaleString()}원

═══════════════════════════════════════════════════════════════
                            🏦 자산 현황
═══════════════════════════════════════════════════════════════

🔸 자산 현황
${assetListText}
   ─────────────────────────────────────
   💎 총 자산                ${totalAsset.toLocaleString()}원

═══════════════════════════════════════════════════════════════
                            📈 분석 및 코멘트
═══════════════════════════════════════════════════════════════

✅ 수입 대비 지출 비율: ${expenseRate}% ${parseFloat(expenseRate) < 80 ? '(양호)' : parseFloat(expenseRate) < 90 ? '(보통)' : '(주의)'}
${balance > 0 ? '✅' : '⚠️'} 저축률: ${savingsRate}% ${parseFloat(savingsRate) > 20 ? '(우수)' : parseFloat(savingsRate) > 10 ? '(양호)' : '(개선 필요)'}
📊 고정지출 비중: ${totalIncome > 0 ? ((totalFixedExpense / totalIncome) * 100).toFixed(1) : 0}%

📝 이번 달 특이사항:
   - URL 파라미터를 통해 실시간으로 데이터를 받아왔습니다
   - 총 자산: ${totalAsset.toLocaleString()}원
   ${balance > 0 ? '- 흑자 달성!' : '- 적자 발생, 지출 관리 필요'}

📋 다음 달 계획:
   - 지속적인 가계부 관리
   - 데이터 연동 시스템 활용
   ${parseFloat(expenseRate) > 85 ? '- 지출 절약 계획 수립' : '- 현재 수준 유지'}

═══════════════════════════════════════════════════════════════
                        보고서 종료
═══════════════════════════════════════════════════════════════

※ 이 보고서는 URL 파라미터 데이터에서 자동으로 생성되었습니다.
※ 데이터 소스: ${rowId}
※ 생성 시간: ${dateStr}
`;

                // 보고서 표시
                const reportDiv = document.getElementById('reportDiv');
                reportDiv.innerHTML = '<div class="report-preview">' + reportText + '</div>';
                
                // 버튼들 표시
                document.getElementById('copyBtn').style.display = 'inline-block';
                document.getElementById('downloadBtn').style.display = 'inline-block';
                
                showStatus('URL 데이터 기반 보고서가 성공적으로 생성되었습니다!', 'success');
                
                // 전역 변수에 보고서 저장
                window.generatedReport = reportText;
                
            } catch (error) {
                console.error('보고서 생성 오류:', error);
                showStatus('보고서 생성 중 오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        function generateTestReport() {
            // 테스트 데이터로 보고서 생성 (새로운 JSON 형식)
            const testData = {
                rowId: 'TEST_DATA_JSON',
                targetMonth: '2025-07',
                income: {
                    total: 3600000,
                    salary: 3200000,
                    investment: 250000,
                    other: 150000
                },
                expense: {
                    fixed: {
                        total: 2100000,
                        transportation: 120000,
                        subscription: 45000,
                        loan: 300000,
                        insurance: 180000,
                        family: 500000,
                        savings: 800000,
                        communication: 75000,
                        other: 80000
                    },
                    variable: 750000
                },
                assets: [
                    {name: "현금", value: 5200000, type: "liquid"},
                    {name: "적금", value: 12500000, type: "savings"},
                    {name: "주식", value: 3000000, type: "investment"},
                    {name: "부동산", value: 200000000, type: "property"}
                ]
            };
            
            window.urlData = testData;
            generateReportFromURL();
        }

        function copyReport() {
            if (window.generatedReport) {
                navigator.clipboard.writeText(window.generatedReport).then(function() {
                    showStatus('보고서가 클립보드에 복사되었습니다!', 'success');
                }, function(err) {
                    // 클립보드 API 실패 시 대체 방법
                    const textArea = document.createElement('textarea');
                    textArea.value = window.generatedReport;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showStatus('보고서가 클립보드에 복사되었습니다!', 'success');
                    } catch (err) {
                        showStatus('복사 중 오류가 발생했습니다.', 'error');
                    }
                    document.body.removeChild(textArea);
                });
            }
        }

        function downloadReport() {
            if (window.generatedReport) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const date = String(today.getDate()).padStart(2, '0');
                
                const filename = `월별자금현황보고서_${year}-${month}-${date}.txt`;
                
                const blob = new Blob([window.generatedReport], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showStatus('TXT 파일이 다운로드되었습니다: ' + filename, 'success');
            }
        }
    </script>
</body>
</html>